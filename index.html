<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡æ¬Šé‡å‹•æ…‹è©¦ç®—å·¥å…·</title>
    <style>
        :root { --primary: #1a73e8; --danger: #d93025; --bg: #f8f9fa; --success: #188038; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 480px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 15px; font-size: 22px; }
        
        .btn-update { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 15px; transition: 0.2s; }
        .btn-update:active { transform: scale(0.98); background: #1557b0; }
        
        .status-bar { font-size: 12px; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; background: #e8f0fe; color: #1967d2; border: 1px solid #c2e7ff; line-height: 1.5; }
        
        .card { border: 1px solid #f1f3f4; border-radius: 15px; padding: 15px; margin-bottom: 15px; background: #fff; transition: 0.3s; }
        .card:hover { border-color: #d2e3fc; }
        .card h3 { margin: 0 0 12px 0; font-size: 16px; color: #202124; display: flex; align-items: center; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: auto; font-weight: normal; }
        .tag-blue { background: #e8f0fe; color: #1967d2; }
        .tag-green { background: #e6f4ea; color: var(--success); }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 8px; }
        label { display: block; font-size: 11px; color: #5f6368; margin-bottom: 4px; }
        input { width: 100%; padding: 10px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 15px; outline: none; background: #fafafa; }
        input:focus { background: #fff; border-color: var(--primary); }

        .result-box { text-align: right; border-top: 1px dashed #eee; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .result-val { font-size: 20px; font-weight: bold; color: var(--danger); }
        .result-label { font-size: 12px; color: #70757a; }
    </style>
</head>
<body>

<div class="container">
    <h2>æŒ‡æ¨™æ¬Šé‡å³æ™‚è©¦ç®—</h2>
    
    <button class="btn-update" onclick="fetchAllData()">ğŸ”„ æ›´æ–°æœ€æ–°è‚¡åƒ¹èˆ‡æ¬Šé‡</button>
    <div id="status" class="status-bar">å°±ç·’ã€‚é»æ“ŠæŒ‰éˆ•åŒæ­¥è­‰äº¤æ‰€æ•¸æ“šã€‚</div>

    <div class="card" style="background: #fdfefe; border-left: 5px solid #ff9800;">
        <h3>2330 å°ç©é›» <span class="tag tag-blue">æ ¸å¿ƒæŒ‡æ¨™</span></h3>
        <div class="input-row">
            <div>
                <label>ç›®å‰ç¾åƒ¹</label>
                <input type="number" id="tsmc_p" value="1000" oninput="calculate()">
            </div>
            <div>
                <label>é è¨ˆè®Šå‹• (å…ƒ)</label>
                <input type="number" id="tsmc_change" value="10" oninput="calculate()">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>0050 å…ƒå¤§å°ç£ 50 <span id="w_date_0050" class="tag tag-blue">æ¬Šé‡è¼‰å…¥ä¸­</span></h3>
        <div class="input-row">
            <div>
                <label>ç¾åƒ¹</label>
                <input type="number" id="p0050" value="190" oninput="calculate()">
            </div>
            <div>
                <label>å°ç©é›»æ¬Šé‡ (%)</label>
                <input type="number" id="w0050" value="56.5" step="0.01" oninput="calculate()">
            </div>
        </div>
        <div class="result-box">
            <span class="result-label">é ä¼°ç›®æ¨™åƒ¹</span>
            <span id="res0050" class="result-val">--</span>
        </div>
    </div>

    <div class="card">
        <h3>0052 å¯Œé‚¦ç§‘æŠ€ <span id="w_date_0052" class="tag tag-green">æ¬Šé‡è¼‰å…¥ä¸­</span></h3>
        <div class="input-row">
            <div>
                <label>ç¾åƒ¹ (1:5 åˆ†å‰²å¾Œ)</label>
                <input type="number" id="p0052" value="45" oninput="calculate()">
            </div>
            <div>
                <label>å°ç©é›»æ¬Šé‡ (%)</label>
                <input type="number" id="w0052" value="62.3" step="0.01" oninput="calculate()">
            </div>
        </div>
        <div class="result-box">
            <span class="result-label">é ä¼°ç›®æ¨™åƒ¹</span>
            <span id="res0052" class="result-val">--</span>
        </div>
    </div>
</div>

<script>
// API åŸºç¤æ—¥æœŸ (æŠ“æœ€è¿‘ä¸€å€‹æœˆ)
const getPastDate = (days) => new Date(Date.now() - days * 86400000).toISOString().split('T')[0];

// æŠ“å–åƒ¹æ ¼
async function fetchPrice(id) {
    try {
        const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${getPastDate(7)}`;
        const res = await fetch(url);
        const json = await res.json();
        return (json.data && json.data.length > 0) ? json.data[json.data.length - 1].close : null;
    } catch (e) { return null; }
}

// æŠ“å– ETF å…§å°ç©é›»çš„æœ€æ–°æ¬Šé‡
async function fetchTsmcWeight(etfId, inputId, dateTagId) {
    try {
        const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockHolding&data_id=${etfId}&start_date=${getPastDate(45)}`;
        const res = await fetch(url);
        const json = await res.json();
        if (json.data && json.data.length > 0) {
            // æ‰¾å‡ºå°ç©é›» (2330) çš„é‚£ä¸€ç­†
            const tsmcHolding = json.data.filter(item => item.stock_id === "2330").pop();
            if (tsmcHolding) {
                document.getElementById(inputId).value = tsmcHolding.holding_percentage;
                document.getElementById(dateTagId).innerText = "æ¬Šé‡æ—¥æœŸ: " + tsmcHolding.date;
                return true;
            }
        }
        return false;
    } catch (e) { return false; }
}

async function fetchAllData() {
    const status = document.getElementById('status');
    status.innerText = "â³ æ­£åœ¨åŒæ­¥è­‰äº¤æ‰€è‚¡åƒ¹èˆ‡ ETF æ¬Šé‡...";
    
    // åŒæ­¥æŠ“å–åƒ¹æ ¼
    const [p2330, p0050, p0052] = await Promise.all([
        fetchPrice('2330'),
        fetchPrice('0050'),
        fetchPrice('0052')
    ]);

    if (p2330) document.getElementById('tsmc_p').value = p2330;
    if (p0050) document.getElementById('p0050').value = p0050;
    if (p0052) {
        // 0052 åˆ†å‰²è‡ªå‹•ä¿®æ­£
        let correctedP52 = p0052 > 100 ? (p0052 / 5).toFixed(2) : p0052;
        document.getElementById('p0052').value = correctedP52;
    }

    // åŒæ­¥æŠ“å–æ¬Šé‡
    await Promise.all([
        fetchTsmcWeight('0050', 'w0050', 'w_date_0050'),
        fetchTsmcWeight('0052', 'w0052', 'w_date_0052')
    ]);

    status.innerText = "âœ… å…¨æ•¸æ›´æ–°å®Œæˆ (" + new Date().toLocaleTimeString() + ")\næ¬Šé‡ä¾æŠ•ä¿¡æœ€æ–°å…¬å‘Šç‚ºæº–";
    calculate();
}

function calculate() {
    const tsmc = parseFloat(document.getElementById('tsmc_p').value) || 1;
    const change = parseFloat(document.getElementById('tsmc_change').value) || 0;
    const ratio = change / tsmc;

    // 0050
    const p50 = parseFloat(document.getElementById('p0050').value) || 0;
    const w50 = parseFloat(document.getElementById('w0050').value) / 100;
    document.getElementById('res0050').innerText = (p50 * (1 + ratio * w50)).toFixed(2);

    // 0052
    const p52 = parseFloat(document.getElementById('p0052').value) || 0;
    const w52 = parseFloat(document.getElementById('w0052').value) / 100;
    document.getElementById('res0052').innerText = (p52 * (1 + ratio * w52)).toFixed(2);
}

// åˆå§‹åŸ·è¡Œ
calculate();
</script>

</body>
</html>
