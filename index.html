<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSMC ADR çµ‚æ¥µé€£å‹•å·¥å…·</title>
    <style>
        :root { --primary: #1a73e8; --adr-purple: #673ab7; --warn: #f39c12; --danger: #d93025; }
        body { font-family: "PingFang TC", sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 480px; background: white; padding: 25px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 5px; }
        .subtitle { text-align: center; font-size: 12px; color: #888; margin-bottom: 20px; }
        .update-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-bottom: 15px; }
        .status-box { font-size: 12px; text-align: center; color: #666; margin-bottom: 20px; padding: 10px; background: #eef3ff; border-radius: 10px; border: 1px solid #d2e3fc; }
        .card { border: 1px solid #eee; border-radius: 16px; padding: 15px; margin-bottom: 15px; position: relative; }
        .card h3 { margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; }
        .weight-tag { font-size: 11px; background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 20px; margin-left: auto; border: 1px solid #ffe0b2; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-size: 11px; color: #888; display: block; margin-bottom: 4px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-weight: bold; }
        .adr-result { background: #f3e5f5; padding: 12px; border-radius: 12px; margin-top: 10px; border: 1px solid #d1c4e9; text-align: center; }
        .adr-result div { font-size: 12px; color: var(--adr-purple); margin-bottom: 5px; }
        .adr-result b { font-size: 24px; color: #4a148c; }
        .result-area { margin-top: 10px; text-align: right; border-top: 1px dashed #eee; padding-top: 10px; }
        .target-price { color: var(--danger); font-size: 22px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>æŒ‡æ¨™é€£å‹•è©¦ç®—</h2>
    <div class="subtitle">Powered by Alpha Vantage API</div>
    
    <button class="update-btn" onclick="syncAll()">ğŸ”„ é»æ­¤æ›´æ–°å³æ™‚è‚¡åƒ¹ (å…¨çƒé€£å‹•)</button>
    <div id="status" class="status-box">âœ… å°±ç·’ã€‚é»æ“ŠæŒ‰éˆ•åŒæ­¥æœ€æ–°æ•¸æ“š</div>

    <div class="card" style="border-left: 5px solid var(--adr-purple);">
        <h3>TSM ADR (ç´ç´„è­‰äº¤æ‰€)</h3>
        <div class="input-grid">
            <div>
                <label>ADR åƒ¹æ ¼ (USD)</label>
                <input type="number" id="adr_p" value="190.5" step="0.1" oninput="calc()">
            </div>
            <div>
                <label>ç¾é‡‘åŒ¯ç‡</label>
                <input type="number" id="fx_rate" value="32.50" step="0.01" oninput="calc()">
            </div>
        </div>
        <div class="adr-result">
            <div>æ›ç®—å°è‚¡åƒè€ƒåƒ¹ (ADR/5 * åŒ¯ç‡ * 0.8)</div>
            <b id="adr_converted">--</b>
        </div>
    </div>

    <div class="card" style="border-left: 5px solid var(--warn);">
        <h3>å°ç©é›» (2330) åƒæ•¸</h3>
        <div class="input-grid">
            <div><label>ç•¶å‰ç¾åƒ¹</label><input type="number" id="tsmc_p" value="1050" oninput="calc()"></div>
            <div><label>é è¨ˆè®Šå‹• (å…ƒ)</label><input type="number" id="tsmc_chg" value="10" oninput="calc()"></div>
        </div>
    </div>

    <div class="card">
        <h3>0050 å…ƒå¤§å°ç£50 <span class="weight-tag">æ¬Šé‡: 61.5%</span></h3>
        <div class="input-grid">
            <div><label>ç¾åƒ¹</label><input type="number" id="p0050" value="200" oninput="calc()"></div>
            <div><label>å°ç©é›»æ¬Šé‡ %</label><input type="number" id="w0050" value="61.5" step="0.1" oninput="calc()"></div>
        </div>
        <div class="result-area">é ä¼°ç›®æ¨™åƒ¹ï¼š<span id="res0050" class="target-price">--</span></div>
    </div>

    <div class="card">
        <h3>0052 å¯Œé‚¦ç§‘æŠ€ <span class="weight-tag">æ¬Šé‡: 69.3%</span></h3>
        <div class="input-grid">
            <div><label>ç¾åƒ¹ (1:5 åˆ†å‰²å¾Œ)</label><input type="number" id="p0052" value="35.5" oninput="calc()"></div>
            <div><label>å°ç©é›»æ¬Šé‡ %</label><input type="number" id="w0052" value="69.3" step="0.1" oninput="calc()"></div>
        </div>
        <div class="result-area">é ä¼°ç›®æ¨™åƒ¹ï¼š<span id="res0052" class="target-price">--</span></div>
    </div>
</div>

<script>
const ALPHA_KEY = '6S3ILAP3JCOQHT6M';
const getPastDate = (d) => new Date(Date.now() - d * 86400000).toISOString().split('T')[0];

async function syncAll() {
    const status = document.getElementById('status');
    status.innerText = "â³ æ­£åœ¨é€é Alpha Vantage æŠ“å–å ±åƒ¹...";
    
    try {
        // 1. æŠ“å– ADR (TSM) - ä½¿ç”¨ Alpha Vantage å…¨çƒæœ€æ–°å ±åƒ¹
        const adrUrl = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=TSM&apikey=${ALPHA_KEY}`;
        const adrRes = await fetch(adrUrl);
        const adrJson = await adrRes.json();
        
        if (adrJson["Global Quote"] && adrJson["Global Quote"]["05. price"]) {
            document.getElementById('adr_p').value = parseFloat(adrJson["Global Quote"]["05. price"]).toFixed(2);
        }

        // 2. æŠ“å–åŒ¯ç‡ (ä½¿ç”¨ Alpha Vantage åŒ¯ç‡æ¥å£)
        const fxUrl = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=USD&to_currency=TWD&apikey=${ALPHA_KEY}`;
        const fxRes = await fetch(fxUrl);
        const fxJson = await fxRes.json();
        if (fxJson["Realtime Currency Exchange Rate"]) {
            document.getElementById('fx_rate').value = parseFloat(fxJson["Realtime Currency Exchange Rate"]["5. Exchange Rate"]).toFixed(2);
        }

        // 3. æŠ“å–å°è‚¡ (ç¶­æŒ FinMind ä½œç‚ºå°è‚¡ä¾†æºï¼Œè¼ƒç‚ºç²¾æº–)
        const fetchTW = async (id) => {
            const r = await fetch(`https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${id}&start_date=${getPastDate(10)}`);
            const j = await r.json();
            return j.data.length ? j.data[j.data.length-1].close : null;
        };

        const [pTSMC, p50, p52] = await Promise.all([fetchTW('2330'), fetchTW('0050'), fetchTW('0052')]);
        
        if (pTSMC) document.getElementById('tsmc_p').value = pTSMC;
        if (p50) document.getElementById('p0050').value = p50;
        if (p52) document.getElementById('p0052').value = (p52 > 100 ? p52/5 : p52).toFixed(2);

        status.innerText = "âœ… æ•¸æ“šåŒæ­¥æˆåŠŸ (å·²é€£å‹• Alpha Vantage)";
        calc();
    } catch(e) {
        status.innerText = "âŒ è«‹æ±‚å¤±æ•— (å¯èƒ½æ˜¯ API æ¬¡æ•¸é™åˆ¶)";
        console.error(e);
    }
}

function calc() {
    // æ‚¨çš„ ADR æ›ç®—å…¬å¼: (ADR / 5) * åŒ¯ç‡ * 0.8
    const adr = parseFloat(document.getElementById('adr_p').value) || 0;
    const fx = parseFloat(document.getElementById('fx_rate').value) || 0;
    const adrConv = (adr / 5) * fx * 0.8;
    document.getElementById('adr_converted').innerText = adrConv.toFixed(2);

    // ETF ç›®æ¨™åƒ¹è¨ˆç®—å…¬å¼: ç¾åƒ¹ * (1 + (å°ç©é›»è®Šå‹•/å°ç©é›»ç¾åƒ¹) * æ¬Šé‡)
    const tsmcP = parseFloat(document.getElementById('tsmc_p').value) || 1;
    const tsmcChg = parseFloat(document.getElementById('tsmc_chg').value) || 0;
    const changeRatio = tsmcChg / tsmcP;

    // 0050
    const p50 = parseFloat(document.getElementById('p0050').value) || 0;
    const w50 = parseFloat(document.getElementById('w0050').value) / 100;
    document.getElementById('res0050').innerText = (p50 * (1 + changeRatio * w50)).toFixed(2);

    // 0052
    const p52 = parseFloat(document.getElementById('p0052').value) || 0;
    const w52 = parseFloat(document.getElementById('w0052').value) / 100;
    document.getElementById('res0052').innerText = (p52 * (1 + changeRatio * w52)).toFixed(2);
}

// åˆå§‹åŒ–è¨ˆç®—ä¸€æ¬¡
calc();
</script>
</body>
</html>
